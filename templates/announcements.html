{% extends "base.html" %}

{% block title %}
{% if show_meetings %}Meeting Records{% else %}Announcements{% endif %} - Pamoja Agencies SHG
{% endblock %}

{% block content %}
<div class="container my-4">
    <div class="card shadow-lg border-0 mb-4" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
        <div class="card-body text-white text-center py-4">
            <h2 class="mb-0">
                <i class="fas {% if show_meetings %}fa-clipboard-list{% else %}fa-bullhorn{% endif %} me-2"></i>
                {% if show_meetings %}Meeting Records{% else %}Announcements{% endif %}
            </h2>
        </div>
    </div>

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>
            {% if show_meetings %}
                <i class="fas fa-clipboard-list me-2"></i>Meeting Records
            {% else %}
                <i class="fas fa-bullhorn me-2"></i>Announcements
            {% endif %}
        </h1>

        {% if not show_meetings and has_permission(current_user, 'manage_announcements') %}
        <a href="{{ url_for('add_announcement') }}" class="btn btn-primary">
            <i class="fas fa-plus me-2"></i>Create Announcement
        </a>
        {% elif show_meetings and has_permission(current_user, 'record_meetings') %}
        <a href="{{ url_for('add_meeting') }}" class="btn btn-primary">
            <i class="fas fa-plus me-2"></i>Record Meeting
        </a>
        {% endif %}
    </div>

    <!-- Navigation Tabs -->
    <ul class="nav nav-tabs mb-4">
        <li class="nav-item">
            <a class="nav-link {{ 'active' if not show_meetings else '' }}" href="{{ url_for('announcements') }}">
                <i class="fas fa-bullhorn me-1"></i>Announcements
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link {{ 'active' if show_meetings else '' }}" href="{{ url_for('meetings') }}">
                <i class="fas fa-clipboard-list me-1"></i>Meeting Records
            </a>
        </li>
    </ul>

    <!-- Add Announcement Form -->
    {% if form and action == 'Add' and not show_meetings %}
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">
                <i class="fas fa-bullhorn me-2"></i>Create New Announcement
            </h5>
        </div>
        <div class="card-body">
            <form method="POST">
                {{ form.hidden_tag() }}

                <div class="row g-3">
                    <div class="col-md-8">
                        {{ form.title.label(class="form-label") }}
                        {{ form.title(class="form-control", placeholder="Enter announcement title") }}
                        {% if form.title.errors %}
                            <div class="text-danger small">
                                {% for error in form.title.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>

                    <div class="col-md-4 d-flex align-items-end">
                        <div class="form-check">
                            {{ form.is_urgent(class="form-check-input") }}
                            {{ form.is_urgent.label(class="form-check-label") }}
                        </div>
                    </div>

                    <div class="col-12">
                        {{ form.content.label(class="form-label") }}
                        {{ form.content(class="form-control", rows="6", placeholder="Write your announcement content here...") }}
                        {% if form.content.errors %}
                            <div class="text-danger small">
                                {% for error in form.content.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </div>

                <div class="mt-3">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-paper-plane me-2"></i>Publish Announcement
                    </button>
                    <a href="{{ url_for('announcements') }}" class="btn btn-secondary ms-2">
                        <i class="fas fa-times me-2"></i>Cancel
                    </a>
                </div>
            </form>
        </div>
    </div>
    {% endif %}

    <!-- Add Meeting Form -->
    {% if form and action == 'Add' and show_meetings %}
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">
                <i class="fas fa-clipboard-list me-2"></i>Record New Meeting
            </h5>
        </div>
        <div class="card-body">
            <form method="POST">
                {{ form.hidden_tag() }}

                <div class="row g-3">
                    <div class="col-md-6">
                        {{ form.title.label(class="form-label") }}
                        {{ form.title(class="form-control", placeholder="e.g., Monthly General Meeting") }}
                        {% if form.title.errors %}
                            <div class="text-danger small">
                                {% for error in form.title.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>

                    <div class="col-md-6">
                        {{ form.date_held.label(class="form-label") }}
                        {{ form.date_held(class="form-control") }}
                        {% if form.date_held.errors %}
                            <div class="text-danger small">
                                {% for error in form.date_held.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>

                    <div class="col-12">
                        {{ form.agenda.label(class="form-label") }}
                        {{ form.agenda(class="form-control", rows="3", placeholder="Meeting agenda items...") }}
                        {% if form.agenda.errors %}
                            <div class="text-danger small">
                                {% for error in form.agenda.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>

                    <div class="col-12">
                        {{ form.minutes.label(class="form-label") }}
                        {{ form.minutes(class="form-control", rows="6", placeholder="Detailed meeting minutes and discussions...") }}
                        {% if form.minutes.errors %}
                            <div class="text-danger small">
                                {% for error in form.minutes.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>

                    <div class="col-md-6">
                        {{ form.attendees.label(class="form-label") }}
                        {{ form.attendees(class="form-control", rows="3", placeholder="List of members who attended...") }}
                        {% if form.attendees.errors %}
                            <div class="text-danger small">
                                {% for error in form.attendees.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>

                    <div class="col-md-6">
                        {{ form.decisions.label(class="form-label") }}
                        {{ form.decisions(class="form-control", rows="3", placeholder="Decisions made during the meeting...") }}
                        {% if form.decisions.errors %}
                            <div class="text-danger small">
                                {% for error in form.decisions.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </div>

                <div class="mt-3">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-2"></i>Save Meeting Record
                    </button>
                    <a href="{{ url_for('meetings') }}" class="btn btn-secondary ms-2">
                        <i class="fas fa-times me-2"></i>Cancel
                    </a>
                </div>
            </form>
        </div>
    </div>
    {% endif %}

    <!-- Announcements List -->
    {% if not show_meetings %}
    <div class="row">
        {% if announcements %}
            {% for announcement in announcements %}
            <div class="col-12 mb-4">
                <div class="card {% if announcement.is_urgent %}border-warning{% endif %}">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0 d-flex align-items-center">
                            {% if announcement.is_urgent %}
                                <i class="fas fa-exclamation-triangle text-warning me-2"></i>
                                <span class="badge bg-warning text-dark me-2">URGENT</span>
                            {% else %}
                                <i class="fas fa-bullhorn text-primary me-2"></i>
                            {% endif %}
                            {{ announcement.title }}
                        </h5>
                        <div class="text-end">
                            <small class="text-muted d-block">
                                <i class="fas fa-calendar-alt me-1"></i>
                                {{ announcement.date_created.strftime('%B %d, %Y') }}
                            </small>
                            <small class="text-muted d-block">
                                <i class="fas fa-clock me-1"></i>
                                {{ announcement.date_created.strftime('%I:%M %p') }}
                            </small>
                        </div>
                    </div>
                    <div class="card-body">
                        <p class="card-text">{{ announcement.content|replace('\n', '<br>')|safe }}</p>
                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted">
                                <i class="fas fa-user me-1"></i>
                                Published by {{ announcement.creator.full_name }}
                                ({{ announcement.creator.role }})
                            </small>
                            <small class="text-muted">
                                <i class="fas fa-history me-1"></i>
                                <span title="{{ announcement.date_created.strftime('%A, %B %d, %Y at %I:%M %p') }}" 
                                      class="time-ago" 
                                      data-time="{{ announcement.date_created.isoformat() }}">
                                    {{ announcement.date_created.strftime('%b %d, %Y at %I:%M %p') }}
                                </span>
                            </small>
                        </div>
                    </div>
                    <div class="card-footer">
                        <div class="d-flex justify-content-end">
                            {% if has_permission(current_user, 'manage_announcements') %}
                            <a href="{{ url_for('edit_announcement', announcement_id=announcement.id) }}" class="btn btn-sm btn-outline-primary me-1">
                                <i class="fas fa-edit"></i> Edit
                            </a>
                            {% endif %}
                            {% if current_user.role == 'Admin' and not announcement.is_deleted %}
                            <button class="btn btn-sm btn-outline-danger me-1" data-bs-toggle="modal" data-bs-target="#deleteAnnouncementModal{{ announcement.id }}">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                            {% endif %}
                            <a href="{{ url_for('view_announcement', announcement_id=announcement.id) }}" class="btn btn-sm btn-outline-secondary">
                                <i class="fas fa-eye"></i> View
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        {% else %}
        <div class="col-12">
            <div class="text-center py-5">
                <i class="fas fa-bullhorn fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">No announcements yet</h5>
                {% if has_permission(current_user, 'manage_announcements') %}
                <p class="text-muted">Create the first announcement to keep members informed</p>
                <a href="{{ url_for('add_announcement') }}" class="btn btn-primary">
                    <i class="fas fa-plus me-2"></i>Create First Announcement
                </a>
                {% else %}
                <p class="text-muted">Announcements from secretaries and administrators will appear here</p>
                {% endif %}
            </div>
        </div>
        {% endif %}
    </div>
    {% endif %}

    <!-- Meeting Records List -->
    {% if show_meetings %}
    <div class="row">
        {% if meetings %}
            {% for meeting in meetings %}
            <div class="col-12 mb-4">
                <div class="card">
                    <div class="card-header">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <h5 class="mb-0">
                                    <i class="fas fa-clipboard-list me-2"></i>
                                    {{ meeting.title }}
                                </h5>
                            </div>
                            <div class="col-md-4 text-md-end">
                                <div class="meeting-time-info">
                                    <span class="badge bg-primary d-block mb-1">
                                        <i class="fas fa-calendar me-1"></i>Meeting Date
                                    </span>
                                    <small class="text-muted d-block">
                                        {{ meeting.date_held.strftime('%A, %B %d, %Y') }}
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        {% if meeting.agenda %}
                        <div class="mb-3">
                            <h6><i class="fas fa-list-ul me-2"></i>Agenda</h6>
                            <p class="text-muted">{{ meeting.agenda|replace('\n', '<br>')|safe }}</p>
                        </div>
                        {% endif %}

                        <div class="mb-3">
                            <h6><i class="fas fa-file-alt me-2"></i>Meeting Minutes</h6>
                            <p>{{ meeting.minutes|replace('\n', '<br>')|safe }}</p>
                        </div>

                        <div class="row">
                            {% if meeting.attendees %}
                            <div class="col-md-6">
                                <h6><i class="fas fa-users me-2"></i>Attendees</h6>
                                <p class="text-muted small">{{ meeting.attendees|replace('\n', '<br>')|safe }}</p>
                            </div>
                            {% endif %}

                            {% if meeting.decisions %}
                            <div class="col-md-6">
                                <h6><i class="fas fa-gavel me-2"></i>Decisions Made</h6>
                                <p class="text-muted small">{{ meeting.decisions|replace('\n', '<br>')|safe }}</p>
                            </div>
                            {% endif %}
                        </div>

                        <div class="text-end mt-3 pt-3 border-top">
                            <div class="row text-muted small">
                                <div class="col-md-6">
                                    <i class="fas fa-user me-1"></i>
                                    <strong>Recorded by:</strong> {{ meeting.recorder.full_name }}
                                </div>
                                <div class="col-md-6 text-md-end">
                                    <i class="fas fa-clock me-1"></i>
                                    <strong>Recorded on:</strong> 
                                    <span title="{{ meeting.date_recorded.strftime('%A, %B %d, %Y at %I:%M %p') }}" 
                                          class="time-ago" 
                                          data-time="{{ meeting.date_recorded.isoformat() }}">
                                        {{ meeting.date_recorded.strftime('%b %d, %Y at %I:%M %p') }}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card-footer">
                        <div class="d-flex justify-content-end">
                            {% if has_permission(current_user, 'record_meetings') %}
                            <a href="{{ url_for('edit_meeting', meeting_id=meeting.id) }}" class="btn btn-sm btn-outline-primary me-1">
                                <i class="fas fa-edit"></i> Edit
                            </a>
                            {% endif %}
                            {% if current_user.role == 'Admin' and not meeting.is_deleted %}
                            <button class="btn btn-sm btn-outline-danger me-1" data-bs-toggle="modal" data-bs-target="#deleteMeetingModal{{ meeting.id }}">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                            {% endif %}
                            <a href="{{ url_for('view_meeting', meeting_id=meeting.id) }}" class="btn btn-sm btn-outline-secondary">
                                <i class="fas fa-eye"></i> View
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        {% else %}
        <div class="col-12">
            <div class="text-center py-5">
                <i class="fas fa-clipboard-list fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">No meeting records yet</h5>
                {% if has_permission(current_user, 'record_meetings') %}
                <p class="text-muted">Start recording meeting minutes to keep track of group decisions</p>
                <a href="{{ url_for('add_meeting') }}" class="btn btn-primary">
                    <i class="fas fa-plus me-2"></i>Record First Meeting
                </a>
                {% else %}
                <p class="text-muted">Meeting records from secretaries will appear here</p>
                {% endif %}
            </div>
        </div>
        {% endif %}
    </div>
    {% endif %}
</div>

{% for announcement in announcements %}
<div class="modal fade" id="deleteAnnouncementModal{{ announcement.id }}" tabindex="-1" aria-labelledby="deleteAnnouncementModalLabel{{ announcement.id }}" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteAnnouncementModalLabel{{ announcement.id }}">Confirm Deletion</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this announcement?</p>
                <label for="deleteReason{{ announcement.id }}" class="form-label">Reason for deletion (Admin only):</label>
                <input type="text" class="form-control" id="deleteReason{{ announcement.id }}" name="deleteReason">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form action="{{ url_for('delete_announcement', announcement_id=announcement.id) }}" method="POST" style="display:inline;">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                    <input type="hidden" name="reason" id="deleteReasonInput{{ announcement.id }}">
                    <button type="submit" class="btn btn-danger" onclick="
                        const reason = document.getElementById('deleteReason{{ announcement.id }}').value.trim();
                        if (!reason) {
                            alert('Please provide a reason for deletion');
                            return false;
                        }
                        document.getElementById('deleteReasonInput{{ announcement.id }}').value = reason;
                        return confirm('Are you sure you want to delete this announcement?');
                    ">Delete</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endfor %}

{% for meeting in meetings %}
<div class="modal fade" id="deleteMeetingModal{{ meeting.id }}" tabindex="-1" aria-labelledby="deleteMeetingModalLabel{{ meeting.id }}" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteMeetingModalLabel{{ meeting.id }}">Confirm Deletion</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this meeting record?</p>
                <label for="deleteReason{{ meeting.id }}" class="form-label">Reason for deletion (Admin only):</label>
                <input type="text" class="form-control" id="deleteReason{{ meeting.id }}" name="deleteReason">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form action="{{ url_for('delete_meeting', meeting_id=meeting.id) }}" method="POST" style="display:inline;">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                    <input type="hidden" name="reason" id="deleteReasonInput{{ meeting.id }}">
                    <button type="submit" class="btn btn-danger" onclick="
                        const reason = document.getElementById('deleteReason{{ meeting.id }}').value.trim();
                        if (!reason) {
                            alert('Please provide a reason for deletion');
                            return false;
                        }
                        document.getElementById('deleteReasonInput{{ meeting.id }}').value = reason;
                        return confirm('Are you sure you want to delete this meeting record?');
                    ">Delete</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endfor %}

{% endblock %}
